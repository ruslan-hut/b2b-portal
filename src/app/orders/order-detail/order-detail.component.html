<div class="order-detail-container">
  <div class="detail-header">
    <div class="header-actions">
      <button class="btn-back" (click)="goBack()">&larr; {{ 'orders.backToOrders' | translate }}</button>
      @if (!loading && !error && order) {
        <button class="btn-export" (click)="exportToExcel()">
          <span class="material-icons">download</span>
          <span class="btn-export-text">Excel</span>
        </button>
      }
    </div>
  </div>

  @if (loading) {
    <div class="loading">{{ 'common.loading' | translate }}</div>
  }
  @if (error) {
    <div class="error">{{ error }}</div>
  }

  @if (!loading && !error && order) {
    <div class="detail-content">
      <!-- Combined order details card (desktop: single card, mobile: separate sections) -->
      <div class="section order-details-combined">
        <!-- Order Information -->
        <div class="order-info-subsection">
          <h3>{{ 'orders.orderInformation' | translate }}</h3>
          <div class="info-grid">
            <div><strong>{{ 'orders.orderNumber' | translate }}:</strong> {{ order.number || order.id }}</div>
            <div><strong>{{ 'orders.status' | translate }}:</strong>
            <span class="status-badge" [ngClass]="getStatusClass(order.status)">
              {{ getTranslatedStatus(order.status) }}
            </span>
          </div>
          <div>
            <strong>{{ 'orders.created' | translate }}:</strong> {{ formatDate(order.createdAt) }}
          </div>
          <div>
            <strong>{{ 'orders.updated' | translate }}:</strong> {{ formatDate(order.updatedAt || order.createdAt) }}
          </div>
          @if (order.comment) {
            <div>
              <strong>{{ 'orders.comment' | translate }}:</strong> {{ order.comment }}
            </div>
          }
        </div>
      </div>

      <!-- Delivery Address -->
      <div class="delivery-info-subsection">
        <h3>{{ 'orders.deliveryAddress' | translate }}</h3>
        @if (hasDeliveryAddress()) {
          <div class="info-grid">
            @if (order.addressText) {
              <div>
                <strong>{{ 'orders.street' | translate }}:</strong> {{ order.addressText }}
              </div>
            }
            @if (order.city) {
              <div>
                <strong>{{ 'orders.city' | translate }}:</strong> {{ order.city }}
              </div>
            }
            @if (order.zipcode) {
              <div>
                <strong>{{ 'orders.zipCode' | translate }}:</strong> {{ order.zipcode }}
              </div>
            }
            @if (order.countryCode) {
              <div>
                <strong>{{ 'orders.country' | translate }}:</strong> {{ order.countryCode }}
              </div>
            }
          </div>
        } @else {
          <p class="no-data">{{ 'orders.noAddressProvided' | translate }}</p>
        }
      </div>

      <!-- Order Items -->
      <div class="items-subsection">
        <h3>{{ 'orders.orderItems' | translate }} ({{ order.items.length }})</h3>
        <!-- Desktop table view -->
        <table class="items-table items-table-desktop">
          <thead>
            <tr>
              <th>{{ 'orders.sku' | translate }}</th>
              <th>{{ 'orders.productName' | translate }}</th>
              <th>{{ 'products.quantity' | translate }}</th>
              <th>{{ 'orders.basePrice' | translate }}</th>
              <th>{{ 'orders.priceWithVat' | translate }}</th>
              <th>{{ 'orders.discount' | translate }} (%)</th>
              <th>{{ 'orders.priceAfterDiscount' | translate }}</th>
              <th>{{ 'orders.total' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (item of order.items; track item) {
              <tr>
                <td>{{ item.sku || '-' }}</td>
                <td>{{ item.productName }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.price.toFixed(2) }}</td>
                <td>{{ (item.priceWithVat || 0).toFixed(2) }}</td>
                <td>{{ item.discount !== undefined ? item.discount + '%' : '-' }}</td>
                <td>{{ (item.priceAfterDiscountWithVat || 0).toFixed(2) }}</td>
                <td>{{ item.subtotal.toFixed(2) }}</td>
              </tr>
            }
            @if (order.items.length === 0) {
              <tr>
                <td colspan="8" class="no-data">{{ 'orders.noItems' | translate }}</td>
              </tr>
            }
          </tbody>
        </table>
        <!-- Mobile card view -->
        <div class="items-cards-mobile">
          @if (order.items.length === 0) {
            <div class="no-data-card">{{ 'orders.noItems' | translate }}</div>
          }
          @for (item of getVisibleItems(); track item; let i = $index) {
            <div class="item-card" [class.expanded]="isItemExpanded(i)" (click)="toggleItemExpanded(i)">
              <!-- Collapsed view: name, qty, total -->
              <div class="item-card-collapsed">
                <div class="collapsed-main">
                  <span class="collapsed-name">{{ item.productName }}</span>
                  <span class="collapsed-sku">{{ item.sku || '' }}</span>
                </div>
                <div class="collapsed-right">
                  <span class="collapsed-qty">{{ item.quantity }}</span>
                  <span class="collapsed-total">{{ item.subtotal.toFixed(2) }}</span>
                </div>
                <span class="expand-icon material-icons">{{ isItemExpanded(i) ? 'expand_less' : 'expand_more' }}</span>
              </div>
              <!-- Expanded details -->
              @if (isItemExpanded(i)) {
                <div class="item-card-expanded">
                  <div class="detail-row">
                    <span class="detail-label">{{ 'orders.basePrice' | translate }}</span>
                    <span class="detail-value">{{ item.price.toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">{{ 'orders.priceWithVat' | translate }}</span>
                    <span class="detail-value">{{ (item.priceWithVat || 0).toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
                  </div>
                  @if (item.discount !== undefined && item.discount > 0) {
                    <div class="detail-row discount-row">
                      <span class="detail-label">{{ 'orders.discount' | translate }}</span>
                      <span class="detail-value discount-value">-{{ item.discount }}%</span>
                    </div>
                  }
                  <div class="detail-row">
                    <span class="detail-label">{{ 'orders.priceAfterDiscount' | translate }}</span>
                    <span class="detail-value">{{ (item.priceAfterDiscountWithVat || 0).toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
                  </div>
                  <div class="detail-row total-row">
                    <span class="detail-label">{{ 'orders.total' | translate }}</span>
                    <span class="detail-value total-value">{{ item.subtotal.toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
                  </div>
                </div>
              }
            </div>
          }
          @if (hasMoreItems()) {
            <button class="btn-show-more" (click)="toggleShowAllItems()">
              @if (showAllItems) {
                <span class="material-icons">expand_less</span>
                {{ 'orders.showLess' | translate }}
              } @else {
                <span class="material-icons">expand_more</span>
                {{ 'orders.showMore' | translate }} ({{ getRemainingItemsCount() }})
              }
            </button>
          }
        </div>
      </div>

      <!-- Order Totals -->
      <div class="totals-subsection">
        <h3>{{ 'orders.orderTotals' | translate }}</h3>
        <div class="totals-breakdown">
          @if (hasDiscount()) {
            <div class="total-row">
              <span class="total-label">{{ 'products.originalPrice' | translate }}:</span>
              <span class="total-value">{{ getOriginalTotal().toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
            </div>
          }
          @if (hasDiscount()) {
            <div class="total-row discount-row">
              <span class="total-label">{{ 'products.discount' | translate }} ({{ order.discountPercent }}%):</span>
              <span class="total-value discount-value">-{{ getDiscountAmount().toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
            </div>
          }
          <div class="total-row subtotal-row" [class.first-row]="!hasDiscount()">
            <span class="total-label">{{ 'products.subtotal' | translate }}:</span>
            <span class="total-value">{{ getSubtotal().toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
          </div>
          @if (getVatAmount() > 0) {
            <div class="total-row vat-row">
              <span class="total-label">{{ 'products.vat' | translate }}@if (order.vatRate) {
                <span> ({{ order.vatRate }}%)</span>
              }:</span>
              <span class="total-value">{{ getVatAmount().toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
            </div>
          }
          <div class="total-row final-total-row">
            <span class="total-label">{{ 'products.total' | translate }}:</span>
            <span class="total-value final-total">{{ getFinalTotal().toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Status history section -->
    <div class="section items-section history-section">
      <h3>{{ 'orders.statusHistory' | translate }}</h3>
      @if (historyLoading) {
        <div class="loading">{{ 'common.loading' | translate }}</div>
      }
      @if (!historyLoading) {
        <!-- Desktop table view -->
        <table class="items-table history-table history-table-desktop">
          <thead>
            <tr>
              <th>{{ 'orders.date' | translate }}</th>
              <th>{{ 'orders.user' | translate }}</th>
              <th>{{ 'orders.status' | translate }}</th>
              <th>{{ 'orders.comment' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (h of history; track h) {
              <tr>
                <td>{{ formatDate(h.created_at) }}</td>
                <td>{{ (h.user_firstname || '') + ' ' + (h.user_lastname || '') || '-' }}</td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(h.status)">
                    {{ getTranslatedStatus(h.status) }}
                  </span>
                </td>
                <td>{{ h.comment || '-' }}</td>
              </tr>
            }
            @if (history.length === 0) {
              <tr>
                <td colspan="4" class="no-data">{{ 'orders.noHistory' | translate }}</td>
              </tr>
            }
          </tbody>
        </table>
        <!-- Mobile card view -->
        <div class="history-cards-mobile">
          @if (history.length === 0) {
            <div class="no-data-card">{{ 'orders.noHistory' | translate }}</div>
          }
          @for (h of history; track h) {
            <div class="history-card">
              <div class="history-card-header">
                <span class="history-date">{{ formatDate(h.created_at) }}</span>
                <span class="status-badge" [ngClass]="getStatusClass(h.status)">
                  {{ getTranslatedStatus(h.status) }}
                </span>
              </div>
              @if ((h.user_firstname || h.user_lastname)) {
                <div class="history-user">
                  {{ (h.user_firstname || '') + ' ' + (h.user_lastname || '') }}
                </div>
              }
              @if (h.comment) {
                <div class="history-comment">{{ h.comment }}</div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>
}
</div>

