<div class="order-detail-container">
  <div class="detail-header">
    <button class="btn-back" (click)="goBack()">
      <span class="material-icons">arrow_back</span>
      <span class="btn-text">Back</span>
    </button>
    <h2>Order Details</h2>
  </div>

  @if (loading) {
    <div class="loading">Loading order details...</div>
  }
  @if (error) {
    <div class="error">{{ error }}</div>
  }

  @if (!loading && !error && order) {
    <div class="detail-content">
      <div class="section order-info">
        <h3>Order Information</h3>
        <div class="info-grid">
          <div><strong>Order:</strong> {{ order.number || order.uid }}</div>
          <div><strong>Status: </strong> <span [class]="getStatusClass(order.status)">{{ order.status }}</span></div>
          <div><strong>Created:</strong> {{ formatDate(order.created_at) }}</div>
          <div><strong>Updated:</strong> {{ formatDate(order.last_update || order.created_at) }}</div>
          @if (order.comment) {
            <div><strong>Comment:</strong> {{ order.comment }}</div>
          }
        </div>
      </div>
      <div class="section client-info">
        <h3>Client Information</h3>
        @if (client) {
          <div>
            <div class="info-grid">
              <div><strong>Name:</strong> {{ client.name }}</div>
              <div><strong>Email:</strong> {{ client.email }}</div>
              <div><strong>Phone:</strong> {{ client.phone }}</div>
              <div><strong>Discount:</strong> {{ client.discount || 0 }}%</div>
              <div><strong>VAT Rate:</strong> {{ client.vat_rate !== undefined ? client.vat_rate + '%' : '-' }}</div>
              <div><strong>VAT Number:</strong> {{ client.vat_number || '-' }}</div>
            </div>
          </div>
        } @else {
          <div class="no-data">Client information not available</div>
        }
      </div>
      <div class="section shipping-info">
        <h3>Delivery Address</h3>
        @if (hasDeliveryAddress()) {
          <div class="info-grid">
            @if (order.address_text) {
              <div>
                <strong>Street:</strong> {{ order.address_text }}
              </div>
            }
            @if (order.city) {
              <div>
                <strong>City:</strong> {{ order.city }}
              </div>
            }
            @if (order.zipcode) {
              <div>
                <strong>Zip Code:</strong> {{ order.zipcode }}
              </div>
            }
            @if (order.country_code) {
              <div>
                <strong>Country:</strong> {{ order.country_code }}
              </div>
            }
          </div>
        } @else {
          <p class="no-data">No address provided</p>
        }
      </div>
      <div class="section items-section">
        <h3>Order Items ({{ items.length }})</h3>

        <!-- Desktop Table -->
        <table class="items-table desktop-only">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Product Name</th>
              <th>Quantity</th>
              <th title="Base unit price without discount or VAT">Base Price</th>
              <th title="Base price with VAT (before discount)">Price + VAT</th>
              <th title="Discount percentage applied to this item">Discount (%)</th>
              <th title="Unit price after discount, with VAT">Price w/ Discount + VAT</th>
              <th title="Total including VAT for this item">Total</th>
            </tr>
          </thead>
          <tbody>
            @for (item of items; track item) {
              <tr>
                <td>{{ item.product_sku || '-' }}</td>
                <td>{{ getProductName(item.product_uid) }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ (item.price/100).toFixed(2) }}</td>
                <td>{{ (item.price_with_vat/100).toFixed(2) }}</td>
                <td>{{ item.discount !== undefined ? item.discount + '%' : '-' }}</td>
                <td>{{ (item.price_after_discount_with_vat/100).toFixed(2) }}</td>
                <td>{{ (item.total/100).toFixed(2) }}</td>
              </tr>
            }
            @if (items.length === 0) {
              <tr>
                <td colspan="8" class="no-data">No items found for this order</td>
              </tr>
            }
          </tbody>
        </table>

        <!-- Mobile Cards -->
        <div class="items-cards mobile-only">
          @for (item of visibleItems; track item) {
            <div class="item-card">
              <div class="item-card-header">
                <span class="item-name">{{ getProductName(item.product_uid) }}</span>
                <span class="item-total">{{ (item.total/100).toFixed(2) }}</span>
              </div>
              <div class="item-card-sku">SKU: {{ item.product_sku || '-' }}</div>
              <div class="item-card-details">
                <div class="detail-item">
                  <span class="label">Qty:</span>
                  <span class="value">{{ item.quantity }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Base:</span>
                  <span class="value">{{ (item.price/100).toFixed(2) }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">+VAT:</span>
                  <span class="value">{{ (item.price_with_vat/100).toFixed(2) }}</span>
                </div>
                @if (item.discount) {
                  <div class="detail-item discount">
                    <span class="label">Disc:</span>
                    <span class="value">-{{ item.discount }}%</span>
                  </div>
                }
              </div>
            </div>
          }
          @if (hasMoreItems) {
            <button class="btn-show-more" (click)="toggleShowAllItems()">
              @if (showAllItems) {
                <span class="material-icons">expand_less</span>
                <span>Show less</span>
              } @else {
                <span class="material-icons">expand_more</span>
                <span>Show {{ hiddenItemsCount }} more items</span>
              }
            </button>
          }
          @if (items.length === 0) {
            <div class="no-data-card">No items found for this order</div>
          }
        </div>
      </div>
      <!-- Order Totals Section -->
      <div class="section totals-section">
        <h3>Order Totals</h3>
        <div class="totals-breakdown">
          @if (order.discount_percent && order.discount_percent > 0 && order.original_total) {
            <div class="total-row">
              <span class="total-label">Original Total:</span>
              <span class="total-value">{{ (order.original_total/100).toFixed(2) }}</span>
            </div>
          }
          @if (order.discount_percent && order.discount_percent > 0 && order.discount_amount) {
            <div class="total-row discount-row">
              <span class="total-label">Discount ({{ order.discount_percent }}%):</span>
              <span class="total-value discount-value">-{{ (order.discount_amount/100).toFixed(2) }}</span>
            </div>
          }
          <div class="total-row subtotal-row">
            <span class="total-label">Subtotal (Net):</span>
            <span class="total-value">{{ order.subtotal !== undefined ? (order.subtotal/100).toFixed(2) : '-' }}</span>
          </div>
          @if (order.total_vat && order.total_vat > 0) {
            <div class="total-row vat-row">
              <span class="total-label">VAT@if (order.vat_rate) {
                <span> ({{ order.vat_rate }}%)</span>
              }:</span>
              <span class="total-value">{{ (order.total_vat/100).toFixed(2) }}</span>
            </div>
          }
          <div class="total-row final-total-row">
            <span class="total-label">Total (Gross):</span>
            <span class="total-value final-total">{{ (order.total/100).toFixed(2) }}</span>
          </div>
        </div>
      </div>
      <!-- Status history section -->
      <div class="section history-section">
        <h3>Status History</h3>

        <!-- Desktop Table -->
        <table class="items-table history-table desktop-only">
          <thead>
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Status</th>
              <th>Comment</th>
            </tr>
          </thead>
          <tbody>
            @for (h of history; track h) {
              <tr>
                <td>{{ formatDate(h.created_at) }}</td>
                <td>{{ (h.user_firstname || '') + ' ' + (h.user_lastname || '') }}</td>
                <td>{{ h.status }}</td>
                <td>{{ h.comment || '-' }}</td>
              </tr>
            }
            @if (history.length === 0 && !historyLoading) {
              <tr>
                <td colspan="4" class="no-data">No history entries</td>
              </tr>
            }
          </tbody>
        </table>

        <!-- Mobile Cards -->
        <div class="history-cards mobile-only">
          @for (h of history; track h) {
            <div class="history-card">
              <div class="history-card-header">
                <span class="history-status" [class]="getStatusClass(h.status)">{{ h.status }}</span>
                <span class="history-date">{{ formatDate(h.created_at) }}</span>
              </div>
              <div class="history-card-user">{{ (h.user_firstname || '') + ' ' + (h.user_lastname || '') || 'System' }}</div>
              @if (h.comment) {
                <div class="history-card-comment">{{ h.comment }}</div>
              }
            </div>
          }
          @if (history.length === 0 && !historyLoading) {
            <div class="no-data-card">No history entries</div>
          }
        </div>
      </div>
    </div>
  }
</div>
