<div class="orders-container">
  <app-action-bar>
    <div actionBarLeft>
      <button class="btn-filter" (click)="toggleFilters()" [class.active]="isFiltersExpanded">
        <span class="material-icons">filter_list</span>
        <span class="btn-text">Filters</span>
        <span class="material-icons toggle-icon">{{ isFiltersExpanded ? 'expand_less' : 'expand_more' }}</span>
      </button>
    </div>
    <div actionBarRight></div>
  </app-action-bar>

  <div class="filters" [class.expanded]="isFiltersExpanded">
    <div class="filter-group">
      <label>Status:</label>
      <select [(ngModel)]="statusFilter" (change)="onFilterChange()">
        @for (option of statusOptions; track option) {
          <option [value]="option.value">
            {{ option.label }}
          </option>
        }
      </select>
    </div>
    <div class="filter-group">
      <label>Store:</label>
      <select [(ngModel)]="storeFilter" (change)="onFilterChange()">
        @for (option of storeOptions; track option) {
          <option [value]="option.value">
            {{ option.label }}
          </option>
        }
      </select>
    </div>
    <div class="filter-group">
      <label>Price Type:</label>
      <select [(ngModel)]="priceTypeFilter" (change)="onFilterChange()">
        @for (option of priceTypeOptions; track option) {
          <option [value]="option.value">
            {{ option.label }}
          </option>
        }
      </select>
    </div>
    <div class="filter-group">
      <label>Search:</label>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        placeholder="Search by order number or client"
        />
    </div>
  </div>

  @if (loading) {
    <div class="loading">Loading orders...</div>
  }
  @if (error) {
    <div class="error">{{ error }}</div>
  }

  @if (!loading && !error) {
    <!-- Desktop Table View -->
    <div class="orders-table desktop-only">
      <table>
        <thead>
          <tr>
            <th>Created</th>
            <th>Order Number</th>
            <th>Status</th>
            <th>Client Name</th>
            <th>Store</th>
            <th>Price Type</th>
            <th title="Client discount percentage applied to this order (0-100%)">Discount</th>
            <th title="VAT rate percentage used for this order (0-100%)">VAT Rate</th>
            <th title="Order subtotal before VAT (net amount)">Subtotal (Net)</th>
            <th title="Total VAT amount calculated for this order">VAT Amount</th>
            <th title="Order total including VAT (gross amount)">Total (Gross)</th>
            <th>Currency</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (order of filteredOrders; track order) {
            <tr
              class="clickable-row"
              (click)="viewOrderDetail(order)">
              <td>{{ formatDate(order.created_at) }}</td>
              <td>{{ order.number || order.uid }}</td>
              <td>
                <span [class]="getStatusClass(order.status)">
                  {{ order.status }}
                </span>
              </td>
              <td>{{ getClientName(order.client_uid) }}</td>
              <td>{{ getStoreName(order.store_uid) }}</td>
              <td>{{ getPriceTypeName(order.price_type_uid) }}</td>
              <td>{{ order.discount_percent !== undefined ? order.discount_percent + '%' : '-' }}</td>
              <td>{{ order.vat_rate !== undefined ? order.vat_rate + '%' : '-' }}</td>
              <td>{{ order.subtotal !== undefined ? (order.subtotal/100).toFixed(2) : '-' }}</td>
              <td>{{ order.total_vat !== undefined ? (order.total_vat/100).toFixed(2) : '-' }}</td>
              <td>{{ (order.total/100).toFixed(2) }}</td>
              <td>{{ order.currency_code }}</td>
              <td>{{ formatDate(order.last_update || order.created_at) }}</td>
              <td class="actions" (click)="$event.stopPropagation()">
                <button class="btn-edit" (click)="editStatus(order)">Change Status</button>
                <button class="btn-delete" (click)="deleteOrder(order)">Delete</button>
              </td>
            </tr>
          }
          @if (filteredOrders.length === 0) {
            <tr>
              <td colspan="14" class="no-data">No orders found</td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Mobile Card View -->
    <div class="orders-cards mobile-only">
      @for (order of filteredOrders; track order) {
        <div class="order-card" [class.expanded]="isCardExpanded(order.uid)" (click)="toggleCardExpanded(order.uid)">
          <div class="card-header">
            <div class="card-title">
              <span class="order-number">{{ order.number || order.uid }}</span>
              <span class="status-badge" [class]="getStatusClass(order.status)">
                {{ order.status }}
              </span>
            </div>
            <div class="card-subtitle">{{ getClientName(order.client_uid) }}</div>
          </div>
          <div class="card-summary">
            <div class="summary-item">
              <span class="label">Total:</span>
              <span class="value">{{ (order.total/100).toFixed(2) }} {{ order.currency_code }}</span>
            </div>
            <div class="summary-item">
              <span class="value date">{{ formatDate(order.created_at).split(' ')[0] }}</span>
            </div>
            <span class="material-icons expand-icon">{{ isCardExpanded(order.uid) ? 'expand_less' : 'expand_more' }}</span>
          </div>
          @if (isCardExpanded(order.uid)) {
            <div class="card-details">
              <div class="detail-row">
                <span class="label">Store:</span>
                <span class="value">{{ getStoreName(order.store_uid) }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Price Type:</span>
                <span class="value">{{ getPriceTypeName(order.price_type_uid) }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Discount:</span>
                <span class="value">{{ order.discount_percent !== undefined ? order.discount_percent + '%' : '-' }}</span>
              </div>
              <div class="detail-row">
                <span class="label">VAT Rate:</span>
                <span class="value">{{ order.vat_rate !== undefined ? order.vat_rate + '%' : '-' }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Subtotal:</span>
                <span class="value">{{ order.subtotal !== undefined ? (order.subtotal/100).toFixed(2) : '-' }}</span>
              </div>
              <div class="detail-row">
                <span class="label">VAT Amount:</span>
                <span class="value">{{ order.total_vat !== undefined ? (order.total_vat/100).toFixed(2) : '-' }}</span>
              </div>
              <div class="card-actions">
                <button class="btn-view" (click)="viewOrderDetail(order); $event.stopPropagation()">
                  <span class="material-icons">visibility</span>
                  View Details
                </button>
                <button class="btn-status" (click)="editStatus(order); $event.stopPropagation()">
                  <span class="material-icons">edit</span>
                  Status
                </button>
              </div>
            </div>
          }
        </div>
      }
      @if (filteredOrders.length === 0) {
        <div class="no-data-card">No orders found</div>
      }
    </div>

    <!-- Pagination -->
    @if (totalPages > 1) {
      <div class="pagination">
        <button [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">Previous</button>
        <span>Page {{ currentPage }} of {{ totalPages }} ({{ total }} total)</span>
        <button [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">Next</button>
      </div>
    }
  }

  <!-- Status Edit Modal -->
  @if (showStatusModal) {
    <div class="modal-overlay" (click)="cancelEdit()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Change Order Status</h2>
        <div class="order-info">
          <p><strong>Order:</strong> {{ editingOrder?.number || editingOrder?.uid }}</p>
          <p><strong>Current Status:</strong> {{ editingOrder?.status }}</p>
        </div>
        <div class="form-group">
          <label>New Status:</label>
          <select [(ngModel)]="newStatus">
            @for (option of statusOptions; track option) {
              <option [value]="option.value" [disabled]="option.value === ''">
                {{ option.label }}
              </option>
            }
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="cancelEdit()">Cancel</button>
          <button type="button" class="btn-save" (click)="saveStatus()">Save</button>
        </div>
      </div>
    </div>
  }
</div>
