<div class="logs-container">
  <div class="header">
    <h1>Logs</h1>
    <div class="header-actions">
      <button class="btn-icon" (click)="refresh()" [disabled]="loading" title="Refresh">
        <span class="material-icons">refresh</span>
      </button>
      <button class="btn-icon btn-cleanup" (click)="cleanupLogs()" title="Cleanup Old Logs">
        <span class="material-icons">delete_sweep</span>
      </button>
    </div>
  </div>

  <!-- Mobile Filter Toggle -->
  <button class="filter-toggle" (click)="toggleFilters()">
    <span class="material-icons">filter_list</span>
    <span>Filters</span>
    <span class="material-icons toggle-icon" [class.expanded]="isFiltersExpanded">
      expand_more
    </span>
  </button>

  <!-- Filters -->
  <div class="filters" [class.expanded]="isFiltersExpanded">
    <div class="filter-group">
      <label for="level">Level:</label>
      <select id="level" [(ngModel)]="levelFilter" (change)="onFilterChange()">
        <option value="">All</option>
        <option value="DEBUG">DEBUG</option>
        <option value="INFO">INFO</option>
        <option value="WARN">WARN</option>
        <option value="ERROR">ERROR</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="userUid">User UID:</label>
      <input type="text" id="userUid" [(ngModel)]="userUidFilter" (input)="onFilterChange()" placeholder="Filter by user UID">
    </div>

    <div class="filter-group">
      <label for="requestId">Request ID:</label>
      <input type="text" id="requestId" [(ngModel)]="requestIdFilter" (input)="onFilterChange()" placeholder="Filter by request ID">
    </div>

    <div class="filter-group">
      <label for="dateFrom">Date From:</label>
      <input type="date" id="dateFrom" [(ngModel)]="dateFromFilter" (change)="onFilterChange()">
    </div>

    <div class="filter-group">
      <label for="dateTo">Date To:</label>
      <input type="date" id="dateTo" [(ngModel)]="dateToFilter" (change)="onFilterChange()">
    </div>

    <div class="filter-group search-group">
      <label for="search">Search:</label>
      <input type="text" id="search" [(ngModel)]="searchFilter" (input)="onSearchChange()" placeholder="Search in message">
    </div>
  </div>

  <!-- Error Message -->
  @if (error) {
    <div class="error-message">
      {{ error }}
    </div>
  }

  <!-- Loading Indicator -->
  @if (loading) {
    <div class="loading">
      Loading logs...
    </div>
  }

  <!-- Logs Content -->
  @if (!loading && !error) {
    <!-- Desktop Table -->
    <div class="logs-table-container desktop-only">
      <table class="logs-table">
        <thead>
          <tr>
            <th class="th-time">Time</th>
            <th class="th-level">Level</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody>
          @for (log of logs; track log) {
            <tr class="log-row" [class.expanded]="isRowExpanded(log.id)" (click)="toggleRow(log.id)">
              <td class="td-time">{{ formatTime(log.time) }}</td>
              <td class="td-level">
                <span class="level-badge" [ngClass]="getLevelClass(log.level)">
                  {{ log.level }}
                </span>
              </td>
              <td class="message-cell">
                <div class="message-preview">{{ log.message }}</div>
                @if (isRowExpanded(log.id)) {
                  <div class="expanded-details">
                    @if (log.user_uid) {
                      <div class="detail-item">
                        <span class="detail-label">User:</span>
                        <span class="detail-value">{{ log.user_uid }}</span>
                      </div>
                    }
                    @if (log.request_id) {
                      <div class="detail-item">
                        <span class="detail-label">Request:</span>
                        <span class="detail-value mono">{{ log.request_id }}</span>
                      </div>
                    }
                    @if (log.extra) {
                      <div class="detail-item extra-item">
                        <span class="detail-label">Extra:</span>
                        <pre class="extra-content">{{ formatExtra(log.extra) | json }}</pre>
                      </div>
                    }
                  </div>
                }
              </td>
            </tr>
          }
          @if (logs.length === 0) {
            <tr>
              <td colspan="3" class="no-data">No logs found</td>
            </tr>
          }
        </tbody>
      </table>
      <!-- Desktop Pagination -->
      @if (totalPages > 1) {
        <div class="pagination">
          <button [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">Previous</button>
          <span>Page {{ currentPage }} of {{ totalPages }} ({{ total }} total)</span>
          <button [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">Next</button>
        </div>
      }
    </div>

    <!-- Mobile Cards -->
    <div class="logs-cards mobile-only">
      @for (log of logs; track log) {
        <div class="log-card" [class.expanded]="isRowExpanded(log.id)" (click)="toggleRow(log.id)">
          <div class="card-header">
            <span class="level-badge" [ngClass]="getLevelClass(log.level)">
              {{ log.level }}
            </span>
            <span class="log-time">{{ formatTime(log.time) }}</span>
          </div>
          <div class="card-message">
            {{ log.message }}
          </div>
          <div class="card-summary">
            @if (log.user_uid) {
              <span class="summary-tag">
                <span class="material-icons">person</span>
                {{ log.user_uid }}
              </span>
            }
            <span class="material-icons expand-icon">{{ isRowExpanded(log.id) ? 'expand_less' : 'expand_more' }}</span>
          </div>
          @if (isRowExpanded(log.id)) {
            <div class="card-details">
              <div class="detail-row">
                <span class="label">Full Time:</span>
                <span class="value">{{ formatDate(log.time) }}</span>
              </div>
              @if (log.user_uid) {
                <div class="detail-row">
                  <span class="label">User UID:</span>
                  <span class="value mono">{{ log.user_uid }}</span>
                </div>
              }
              @if (log.request_id) {
                <div class="detail-row">
                  <span class="label">Request ID:</span>
                  <span class="value mono">{{ log.request_id }}</span>
                </div>
              }
              @if (log.extra) {
                <div class="detail-row extra-row">
                  <span class="label">Extra Data:</span>
                  <pre class="extra-content">{{ formatExtra(log.extra) | json }}</pre>
                </div>
              }
            </div>
          }
        </div>
      }
      @if (logs.length === 0) {
        <div class="no-data-card">No logs found</div>
      }
    </div>

    <!-- Mobile Pagination -->
    @if (totalPages > 1) {
      <div class="mobile-pagination mobile-only">
        <span class="page-info-mobile">Page {{ currentPage }} of {{ totalPages }} ({{ total }} logs)</span>
        <div class="pagination-buttons">
          <button [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">Previous</button>
          <button [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">Next</button>
        </div>
      </div>
    }
  }
</div>
