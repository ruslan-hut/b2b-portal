<div class="my-tasks-container">
  <app-action-bar>
    <div actionBarLeft>
      <select [(ngModel)]="statusFilter" (change)="onFilterChange()" class="status-filter">
        <option value="all">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <button
        class="btn-overdue"
        [class.active]="showOverdueOnly"
        (click)="toggleOverdueOnly()"
      >
        <span class="material-icons">warning</span>
        <span class="btn-text">Overdue Only</span>
      </button>
    </div>
    <div actionBarRight>
      <a routerLink="/admin/crm" [routerLinkActiveOptions]="{exact: true}" routerLinkActive="active" class="btn-nav">
        <span class="material-icons">view_kanban</span>
        <span class="btn-text">Pipeline</span>
      </a>
      <a routerLink="/admin/crm/dashboard" routerLinkActive="active" class="btn-nav">
        <span class="material-icons">dashboard</span>
        <span class="btn-text">Dashboard</span>
      </a>
      <a routerLink="/admin/crm/workload" routerLinkActive="active" class="btn-nav">
        <span class="material-icons">bar_chart</span>
        <span class="btn-text">Workload</span>
      </a>
      <a routerLink="/admin/crm/my-tasks" routerLinkActive="active" class="btn-nav">
        <span class="material-icons">task_alt</span>
        <span class="btn-text">My Tasks</span>
      </a>
      <a routerLink="/admin/crm/settings" routerLinkActive="active" class="btn-nav">
        <span class="material-icons">settings</span>
        <span class="btn-text">Settings</span>
      </a>
    </div>
  </app-action-bar>

  <div *ngIf="error" class="error-message">
    {{ error }}
    <button class="btn-retry" (click)="loadTasks()">Retry</button>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading tasks...</p>
  </div>

  <div *ngIf="!loading && !error && groupedTasksCache.length === 0" class="empty-state">
    <div class="empty-icon">&#128203;</div>
    <h2>No tasks found</h2>
    <p *ngIf="showOverdueOnly">You have no overdue tasks</p>
    <p *ngIf="!showOverdueOnly">You don't have any tasks assigned to you</p>
  </div>

  <div class="task-groups" *ngIf="!loading && groupedTasksCache.length > 0">
    <div class="task-group" *ngFor="let group of groupedTasksCache">
      <div class="group-header" [class.overdue]="group.title === 'Overdue'">
        <span class="group-title">{{ group.title }}</span>
        <span class="group-count">{{ group.tasks.length }}</span>
      </div>

      <div class="task-list">
        <div
          *ngFor="let task of group.tasks"
          class="task-card"
          [class.completed]="task.status === 'completed'"
          [class.overdue]="isOverdue(task)"
        >
          <div class="task-checkbox">
            <button
              class="checkbox-btn"
              [class.checked]="task.status === 'completed'"
              (click)="task.status === 'completed' ? updateTaskStatus(task, 'pending') : completeTask(task)"
            >
              <span *ngIf="task.status === 'completed'">&#10003;</span>
            </button>
          </div>

          <div class="task-content" (click)="goToOrder(task)">
            <div class="task-title">{{ task.title }}</div>
            <div class="task-description" *ngIf="task.description">{{ task.description }}</div>
            <div class="task-meta">
              <span class="priority-badge" [class]="getPriorityClass(task.priority)">
                {{ task.priority }}
              </span>
              <span class="status-badge" [class]="getStatusClass(task.status)">
                {{ task.status | titlecase }}
              </span>
              <span class="due-date" *ngIf="task.due_date" [class.overdue]="isOverdue(task)">
                {{ formatDueDate(task.due_date) }}
              </span>
              <span class="assigned-to" *ngIf="task.assigned_to_name">
                <span class="icon">&#128100;</span> {{ task.assigned_to_name }}
              </span>
            </div>
          </div>

          <div class="task-actions">
            <button
              class="btn-action btn-assign"
              (click)="assignToMe(task)"
              *ngIf="!isAssignedToMe(task)"
              title="Assign to me"
            >
              &#128100;
            </button>
            <select
              class="assignee-dropdown"
              [ngModel]="task.assigned_to_uid || ''"
              (ngModelChange)="reassignTask(task, $event)"
              title="Reassign task"
            >
              <option value="">Unassigned</option>
              <option *ngFor="let user of assignableUsers" [value]="user.uid">
                {{ user.first_name }} {{ user.last_name }}
              </option>
            </select>
            <button
              class="btn-action"
              (click)="updateTaskStatus(task, 'in_progress')"
              *ngIf="task.status === 'pending'"
              title="Start working"
            >
              &#9654;
            </button>
            <button
              class="btn-action btn-view"
              (click)="goToOrder(task)"
              title="View order"
            >
              &#8594;
            </button>
            <button
              class="btn-action btn-delete"
              (click)="deleteTask(task)"
              title="Delete task"
            >
              &#128465;
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
