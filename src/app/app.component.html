<div class="app-container">
  <!-- Offline Indicator -->
  @if (!isOnline) {
    <div class="offline-indicator">
      <div class="offline-content">
        <span class="material-icons offline-icon">signal_wifi_off</span>
        <span class="offline-message">You are currently offline. Some features may be limited.</span>
      </div>
    </div>
  }

  @if (!isAuthRoute && (authService.currentEntity$ | async); as entity) {
    <header class="app-header">
      <div class="header-content">
        <div class="logo" (click)="navigateTo('/products/catalog')">
          <img src="assets/favicon/icon-192.png" alt="Logo" class="logo-icon">
          <span class="logo-text">{{ title }}</span>
        </div>
        <div class="header-actions">
          <button class="btn-cart" (click)="toggleCartPanel()">
            <span class="material-icons cart-icon">shopping_cart</span>
            <span class="cart-text">{{ 'navigation.cart' | translate }} ({{ cartItems.length }})</span>
          </button>
          <div class="user-menu-wrapper">
            <button class="btn-user-menu" (click)="toggleUserMenu()" [attr.aria-label]="'User menu'">
              <div class="user-info">
                <span class="user-name">{{ getDisplayName() }}</span>
                @if (entityType === 'user' && currentEntity) {
                  <span class="user-company">{{ getUserData()?.username }}</span>
                }
                @if (entityType === 'client' && currentEntity) {
                  <span class="user-company">{{ getClientData()?.phone }}</span>
                }
              </div>
              <span class="material-icons user-icon-mobile">person</span>
              <span class="material-icons menu-arrow" [class.open]="isUserMenuOpen">keyboard_arrow_down</span>
            </button>
            <div class="user-menu-dropdown" [class.open]="isUserMenuOpen">
              <div class="menu-section">
                <div class="menu-item user-info-menu-item">
                  <span class="user-name-display">{{ getDisplayName() }}</span>
                  @if (entityType === 'user' && currentEntity) {
                    <span class="user-company-display">{{ getUserData()?.username }}</span>
                  }
                  @if (entityType === 'client' && currentEntity) {
                    <span class="user-company-display">{{ getClientData()?.phone }}</span>
                  }
                </div>
              </div>
              <div class="menu-section">
                <div class="menu-item language-menu-item">
                  <span class="material-icons menu-icon">language</span>
                  <span class="menu-text">{{ 'navigation.language' | translate }}</span>
                  <app-language-switcher></app-language-switcher>
                </div>
              </div>
              <div class="menu-section">
                <a routerLink="/products/catalog" routerLinkActive="active" class="menu-item" (click)="closeUserMenu()">
                  <span class="material-icons menu-icon">inventory_2</span>
                  <span class="menu-text">{{ 'navigation.products' | translate }}</span>
                </a>
                <a routerLink="/orders/history" routerLinkActive="active" class="menu-item" (click)="closeUserMenu()">
                  <span class="material-icons menu-icon">receipt</span>
                  <span class="menu-text">{{ 'navigation.orders' | translate }}</span>
                </a>
                @if (entityType === 'client') {
                  <a routerLink="/profile" routerLinkActive="active" class="menu-item" (click)="closeUserMenu()">
                    <span class="material-icons menu-icon">person</span>
                    <span class="menu-text">{{ 'navigation.profile' | translate }}</span>
                  </a>
                }
                @if (hasAdminAccess()) {
                  <a routerLink="/admin/dashboard" routerLinkActive="active" class="menu-item admin-menu-item" (click)="closeUserMenu()">
                    <span class="material-icons menu-icon">admin_panel_settings</span>
                    <span class="menu-text">Admin Zone</span>
                  </a>
                }
              </div>
              @if (showViewToggle) {
                <div class="menu-section">
                  <button class="menu-item btn-view-toggle-menu" (click)="toggleViewMode(); closeUserMenu()">
                    <span class="material-icons menu-icon">
                      @if (viewMode === 'grid') {
                        view_list
                      }
                      @if (viewMode === 'bulk') {
                        view_module
                      }
                    </span>
                    <span class="menu-text">
                      @if (viewMode === 'grid') {
                        {{ 'navigation.bulkOrder' | translate }}
                      }
                      @if (viewMode === 'bulk') {
                        {{ 'navigation.gridView' | translate }}
                      }
                    </span>
                  </button>
                </div>
              }
              <div class="menu-section">
                <button class="menu-item btn-logout-menu" (click)="logout(); closeUserMenu()">
                  <span class="material-icons menu-icon">logout</span>
                  <span class="menu-text">{{ 'common.logout' | translate }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
  }

  <main class="app-main">
    <router-outlet />
  </main>

  <!-- Update Notification -->
  <app-update-notification></app-update-notification>

  <!-- Order Confirmation Dialog -->
  @if (showOrderDialog) {
    <app-order-confirmation-dialog
      [total]="cartTotal"
      [currencyName]="currencyName"
      [isConfirming]="isCreatingOrder"
      [isSuccess]="isOrderSuccess"
      (closed)="closeOrderDialog()"
    ></app-order-confirmation-dialog>
  }

  <!-- Cart Side Panel -->
  @if (showCartPanel) {
    <div class="cart-overlay" (click)="toggleCartPanel()"></div>
  }
  <div class="cart-panel" [class.open]="showCartPanel">
    <div class="cart-header">
      <h2>{{ 'products.addToCart' | translate }}</h2>
      <button class="close-btn" (click)="toggleCartPanel()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="cart-content">
      @if (cartItems.length === 0) {
        <div class="empty-cart">
          <span class="material-icons empty-icon">shopping_cart</span>
          <p>{{ 'messages.cartCleared' | translate }}</p>
        </div>
      }

      @if (cartItems.length > 0) {
        <div class="cart-items">
          @for (item of cartItems; track item) {
            <div class="cart-item" [class.insufficient-stock]="item.insufficientStock">
              <div class="item-info">
                <span class="item-name">{{ item.productName }}</span>
                <div class="item-details">
                  <div class="price-info">
                    @if (hasDiscount) {
                      <span class="item-price-original">
                        {{ item.price.toFixed(2) }}
                      </span>
                    }
                    <span class="item-price" [class.discounted]="hasDiscount">
                      {{ (item.priceDiscount || item.price).toFixed(2) }}
                    </span>
                  </div>
                  <div class="quantity-control" role="group" aria-label="Quantity controls">
                    <button class="qty-btn" type="button" (click)="updateQuantity(item.productId, item.quantity - 1)" [disabled]="item.quantity <= 1">-</button>
                    <input
                      class="qty-input"
                      type="number"
                      min="1"
                      [ngModel]="item.quantity"
                      (ngModelChange)="updateQuantity(item.productId, $event)"
                      aria-label="Quantity"
                      />
                    <button class="qty-btn" type="button" (click)="updateQuantity(item.productId, item.quantity + 1)">+</button>
                  </div>
                </div>
                @if (item.insufficientStock) {
                  <div class="stock-warning">
                    <span class="material-icons warning-icon">warning</span>
                    <span class="warning-text">
                      {{ 'products.insufficientStock' | translate: {available: item.availableQuantity ?? 0} }}
                    </span>
                  </div>
                }
              </div>
              <div class="item-actions">
                <span class="item-total">{{ item.subtotal.toFixed(2) }}</span>
                <button class="remove-btn" (click)="removeFromCart(item.productId)">
                  {{ 'common.delete' | translate }}
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>

    @if (cartItems.length > 0) {
      <div class="cart-footer">
        <div class="comment-section">
          <div class="comment-header" (click)="commentSectionExpanded = !commentSectionExpanded">
            <label class="comment-label">{{ 'orders.comment' | translate }}:</label>
            <button type="button" class="comment-toggle" [attr.aria-expanded]="commentSectionExpanded" aria-label="Toggle comment section">
              <span class="material-icons">{{ commentSectionExpanded ? 'expand_less' : 'expand_more' }}</span>
            </button>
          </div>
          <div class="comment-content" [class.expanded]="commentSectionExpanded">
            <textarea
              id="orderComment"
              [(ngModel)]="orderComment"
              [placeholder]="'orders.commentPlaceholder' | translate"
              class="comment-textarea"
              rows="3"
            ></textarea>
          </div>
        </div>
        <!-- Cart totals breakdown -->
        <div class="cart-totals-breakdown">
          <!-- Original Total (before discount) -->
          @if (hasDiscount) {
            <div class="total-row original-total-row">
              <span class="total-label">{{ 'products.originalPrice' | translate }}:</span>
              <span class="total-amount original-price-amount">{{ cartOriginalTotal.toFixed(2) }}</span>
            </div>
          }
          <!-- Discount Amount -->
          @if (hasDiscount) {
            <div class="total-row discount-row">
              <span class="total-label">{{ 'products.discount' | translate }} ({{ currentDiscount }}%):</span>
              <span class="total-amount discount-amount">-{{ cartDiscountAmount.toFixed(2) }}</span>
            </div>
          }
          <!-- Subtotal (after discount, before VAT) -->
          <div class="total-row subtotal-row" [class.has-discount-above]="hasDiscount">
            <span class="total-label">{{ 'products.subtotal' | translate }}:</span>
            <span class="total-amount">{{ cartSubtotal.toFixed(2) }}</span>
          </div>
          <!-- VAT (only if > 0) *ngIf="hasVat" -->
          <div class="total-row vat-row" >
            <span class="total-label">{{ 'products.vat' | translate }} ({{ currentVatRate }}%):</span>
            <span class="total-amount">{{ cartVatAmount.toFixed(2) }}</span>
          </div>
          <!-- Final Total -->
          <div class="total-row final-total-row">
            <span class="total-label">{{ 'products.total' | translate }}:</span>
            <span class="total-amount total-emphasis">{{ cartTotal.toFixed(2) }}{{ currencyName ? ' ' + currencyName : '' }}</span>
          </div>
        </div>
        <!-- Delivery Address Selection -->
        @if (entityType === 'client') {
          <app-cart-address
            [address]="currentAddress"
            [isDraft]="true"
            (addressChange)="onAddressChange($event)"
          ></app-cart-address>
        }
        <button class="btn-checkout" (click)="proceedToCheckout()" [disabled]="isCreatingOrder || (entityType === 'client' && !hasSelectedAddress())">
          {{ isCreatingOrder ? ('common.loading' | translate) : ('products.confirmOrder' | translate) }}
        </button>
      </div>
    }
  </div>
</div>
